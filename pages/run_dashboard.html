<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Running Dashboard (Fixed Schema)</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 0; }
    .sub { color: #555; margin-top: 4px; }
    .grid { display: grid; gap: 20px; }
    .two { grid-template-columns: 1fr; }
    .three { grid-template-columns: 1fr; }
    @media (min-width: 1024px) {
      .two { grid-template-columns: 1fr 1fr; }
      .three { grid-template-columns: 1fr 1fr 1fr; }
    }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 12px 0; }
    .controls label { display:flex; gap:6px; align-items:center; }
    input, select, button { padding:8px 10px; border-radius:8px; border:1px solid #ddd; }
    #notes { white-space: pre-wrap; background:#fafafa; border-radius:8px; padding:12px; border:1px solid #eee; }
    .muted { color:#666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>러닝 대시보드</h1>
  <div class="sub">고정 스키마 CSV에서 직접 시각화. (일/주간 추이, 이동통계, Pace↔Speed, 분포, 상자그림, 효율지수)</div>

  <div class="card">
    <div class="controls">
      <label>종류
        <select id="typeFilter"><option value="__ALL__">모두</option></select>
      </label>
      <label>기간
        <input type="date" id="fromDate"> ~ <input type="date" id="toDate">
      </label>
      <label>값 단위
        <select id="paceMode">
          <option value="pace">페이스(분/km)</option>
          <option value="speed">스피드(km/h)</option>
        </select>
      </label>
      <label>이동 통계
        <select id="rollStat">
          <option value="mean">평균</option>
          <option value="median">중앙값</option>
        </select>
      </label>
      <label>윈도우
        <select id="rollWin">
          <option value="7">7일</option>
          <option value="28">28일</option>
        </select>
      </label>
      <label>주간 목표(km)
        <input type="number" id="weeklyGoal" value="30" min="0" step="1" style="width:90px;">
      </label>
      <button id="apply">적용</button>
      <button id="reset">초기화</button>
    </div>
    <div class="muted">포인트를 클릭하면 아래 노트가 표시됩니다.</div>
  </div>

  <div class="grid two">
    <div class="card">
      <h3>일일 거리 (km) + 이동통계</h3>
      <div id="distDaily" style="height:360px;"></div>
    </div>
    <div class="card">
      <h3 id="paceTitle">일일 페이스 (분/km) + 이동통계</h3>
      <div id="paceDaily" style="height:360px;"></div>
    </div>
  </div>

  <div class="grid two">
    <div class="card">
      <h3>일일 RPE</h3>
      <div id="rpeDaily" style="height:300px;"></div>
    </div>
    <div class="card">
      <h3>주간 합계 vs 목표</h3>
      <div id="weeklyTotals" style="height:320px;"></div>
    </div>
  </div>

  <div class="grid three">
    <div class="card">
      <h3>분포: 페이스/스피드</h3>
      <div id="histPace" style="height:280px;"></div>
    </div>
    <div class="card">
      <h3>분포: 거리/ RPE</h3>
      <div id="histDistRpe" style="height:280px;"></div>
    </div>
    <div class="card">
      <h3>상자그림: 타입별 페이스/스피드</h3>
      <div id="boxByType" style="height:280px;"></div>
    </div>
  </div>

  <div class="card">
    <h3>효율 지수 (speed / HR)</h3>
    <div id="efficiency" style="height:320px;"></div>
    <div class="muted">* HR이 비어있는 날은 제외됩니다.</div>
  </div>

  <div class="card">
    <h3>선택한 러닝 노트</h3>
    <div id="notes">(포인트를 클릭하세요)</div>
  </div>

<script>
const DAILY = [{"date": "2025-07-20", "type": "easy", "dist_km": 5.0, "pace_minpkm": 7.9, "hr_avg": 163.0, "rpe": 7.5, "notes": "Track; 30\"×7 cadence drill after; heat ~28C"}, {"date": "2025-08-01", "type": "tempo", "dist_km": 6.0, "pace_minpkm": 7.35, "hr_avg": 165.0, "rpe": 8.0, "notes": "Splits ~6:53; last 6:31"}, {"date": "2025-08-02", "type": "lsd", "dist_km": 12.0, "pace_minpkm": 8.7666666667, "hr_avg": 155.0, "rpe": 3.5, "notes": "Mild knee pain ~8km"}, {"date": "2025-08-03", "type": "easy", "dist_km": 1.0, "pace_minpkm": 6.8, "hr_avg": 142.5, "rpe": 4.0, "notes": "nan"}, {"date": "2025-08-04", "type": "easy", "dist_km": 6.25, "pace_minpkm": 8.3166666667, "hr_avg": 150.0, "rpe": 4.0, "notes": "Slight knee discomfort ~5km; last 1km ~5:18"}, {"date": "2025-08-05", "type": "intervals", "dist_km": 6.0, "pace_minpkm": 7.1666666667, "hr_avg": 151.0, "rpe": 6.5, "notes": "2km WU; 400m on/off, 400m×5"}, {"date": "2025-08-06", "type": "easy", "dist_km": 6.01, "pace_minpkm": 7.9666666667, "hr_avg": 142.5, "rpe": 3.0, "notes": "Last 1km faster"}, {"date": "2025-08-07", "type": "tempo", "dist_km": 7.0, "pace_minpkm": 6.5166666667, "hr_avg": 153.0, "rpe": 4.0, "notes": "RPE blocks 5?6→6?7→7?8"}, {"date": "2025-08-08", "type": "easy", "dist_km": 6.0, "pace_minpkm": 8.2333333333, "hr_avg": 151.0, "rpe": 5.0, "notes": "Hot; hip discomfort"}, {"date": "2025-08-09", "type": "lsd", "dist_km": 15.0, "pace_minpkm": 7.7666666667, "hr_avg": 147.0, "rpe": 6.0, "notes": "Hip improved; knee discomfort after 10km"}, {"date": "2025-08-10", "type": "easy", "dist_km": 5.11, "pace_minpkm": 8.5833333333, "hr_avg": 150.0, "rpe": 4.0, "notes": "Ran with friend; last 1km faster"}, {"date": "2025-08-11", "type": "easy", "dist_km": 8.11, "pace_minpkm": 7.55, "hr_avg": 144.0, "rpe": 4.0, "notes": "Last 2km faster"}, {"date": "2025-08-12", "type": "intervals", "dist_km": 8.0, "pace_minpkm": 7.0, "hr_avg": 136.0, "rpe": 8.0, "notes": "WU 2km; HRpeak 175; side stitch from rep3, 800m×5"}, {"date": "2025-08-14", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 7.1666666667, "hr_avg": 145.0, "rpe": 7.0, "notes": "Cut short; low energy"}, {"date": "2025-08-15", "type": "easy", "dist_km": 8.15, "pace_minpkm": 7.2833333333, "hr_avg": 145.0, "rpe": 5.0, "notes": "Hip discomfort persists; fatigue"}, {"date": "2025-08-16", "type": "lsd", "dist_km": 16.0, "pace_minpkm": 6.7333333333, "hr_avg": 155.0, "rpe": 4.0, "notes": "Felt depleted late; need gels"}, {"date": "2025-08-17", "type": "easy", "dist_km": 5.31, "pace_minpkm": 8.9166666667, "hr_avg": 117.0, "rpe": 3.5, "notes": "Heavy first 2km then ok"}, {"date": "2025-08-18", "type": "easy", "dist_km": 8.15, "pace_minpkm": 7.2166666667, "hr_avg": 142.5, "rpe": 3.0, "notes": "Segments; 400m @5:00 inside"}, {"date": "2025-08-19", "type": "intervals", "dist_km": 9.6, "pace_minpkm": 4.8333333333, "hr_avg": 172.0, "rpe": 8.0, "notes": "Good HR recovery; stitch mid-session 800m×5"}, {"date": "2025-08-20", "type": "easy", "dist_km": 6.33, "pace_minpkm": 9.2, "hr_avg": 132.0, "rpe": 1.5, "notes": "nan"}, {"date": "2025-08-22", "type": "tempo", "dist_km": 8.02, "pace_minpkm": 6.9, "hr_avg": 151.0, "rpe": 6.0, "notes": "Steady; one fast km 5:45"}, {"date": "2025-08-23", "type": "easy", "dist_km": 5.32, "pace_minpkm": 7.8333333333, "hr_avg": 140.0, "rpe": 4.0, "notes": "nan"}, {"date": "2025-08-24", "type": "lsd", "dist_km": 21.11, "pace_minpkm": 7.3333333333, "hr_avg": 147.0, "rpe": 8.0, "notes": "nan"}, {"date": "2025-08-28", "type": "easy", "dist_km": 6.52, "pace_minpkm": 7.8166666667, "hr_avg": 142.5, "rpe": 3.0, "notes": "nan"}, {"date": "2025-08-31", "type": "lsd", "dist_km": 14.01, "pace_minpkm": 7.4833333333, "hr_avg": 147.0, "rpe": 4.5, "notes": "+89m elevation; late fatigue"}, {"date": "2025-09-05", "type": "easy", "dist_km": 10.02, "pace_minpkm": 7.0833333333, "hr_avg": 142.5, "rpe": 5.0, "notes": "No HR"}, {"date": "2025-09-08", "type": "easy", "dist_km": 5.03, "pace_minpkm": 6.6833333333, "hr_avg": 142.5, "rpe": 3.0, "notes": "Return after weather break"}, {"date": "2025-09-10", "type": "tempo", "dist_km": 10.01, "pace_minpkm": 6.6166666667, "hr_avg": 153.0, "rpe": 4.0, "notes": "Finish 1km 5:38"}, {"date": "2025-09-10", "type": "tempo", "dist_km": 8.01, "pace_minpkm": 6.4166666667, "hr_avg": 161.0, "rpe": 4.0, "notes": "High HR; hill +60m"}, {"date": "2025-09-15", "type": "easy", "dist_km": 12.02, "pace_minpkm": 7.0666666667, "hr_avg": 152.0, "rpe": 5.0, "notes": "Zone2-3; one km @6:18"}, {"date": "2025-09-16", "type": "tempo", "dist_km": 8.12, "pace_minpkm": 6.3666666667, "hr_avg": 157.0, "rpe": 4.0, "notes": "Strong steady run"}, {"date": "2025-09-17", "type": "tempo", "dist_km": 8.01, "pace_minpkm": 6.4, "hr_avg": 152.0, "rpe": 3.0, "notes": "3km <6:00 within; finish 5:58"}, {"date": "2025-09-18", "type": "tempo", "dist_km": 9.0, "pace_minpkm": 6.2833333333, "hr_avg": 153.0, "rpe": 5.0, "notes": "nan"}, {"date": "2025-09-28", "type": "race", "dist_km": 21.1, "pace_minpkm": 6.5, "hr_avg": 161.0, "rpe": 8.0, "notes": "Official 2:17:11; avg 6:30/km"}, {"date": "2025-10-05", "type": "easy", "dist_km": 10.47, "pace_minpkm": 7.35, "hr_avg": 148.0, "rpe": 7.0, "notes": "Side stitch pain"}, {"date": "2025-10-08", "type": "lsd", "dist_km": 26.0, "pace_minpkm": 9.45, "hr_avg": 140.0, "rpe": 4.0, "notes": "Long run"}, {"date": "2025-10-12", "type": "easy", "dist_km": 5.07, "pace_minpkm": 10.5666666667, "hr_avg": 120.0, "rpe": 1.0, "notes": "Running w/ novice friend"}, {"date": "2025-10-12", "type": "tempo", "dist_km": 2.03, "pace_minpkm": 5.85, "hr_avg": 155.0, "rpe": 6.5, "notes": "short high intensity run"}, {"date": "2025-10-14", "type": "tempo", "dist_km": 7.0, "pace_minpkm": 6.9, "hr_avg": 153.0, "rpe": 5.0, "notes": "Track; Tried to keep sub 7:00/km"}, {"date": "2025-10-14", "type": "easy", "dist_km": 4.1, "pace_minpkm": 8.4666666667, "hr_avg": 137.0, "rpe": 2.0, "notes": "Running w/ novice friend"}, {"date": "2025-10-15", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.8333333333, "hr_avg": 164.0, "rpe": 7.0, "notes": "Track; Tried to keep sub 6:00/km, HR upto 179, 3km PR 17:23"}, {"date": "2025-10-15", "type": "recovery", "dist_km": 12.0, "pace_minpkm": 7.8, "hr_avg": 148.0, "rpe": 5.0, "notes": "Recovery, bit fatigue after 10km"}, {"date": "2025-10-16", "type": "fartlek", "dist_km": 10.0, "pace_minpkm": 7.1833333333, "hr_avg": 145.0, "rpe": 3.0, "notes": "Running w/ novice friend, Sprint upto 4:25"}, {"date": "2025-10-18", "type": "lsd", "dist_km": 20.0, "pace_minpkm": 7.4333333333, "hr_avg": 138.0, "rpe": 5.0, "notes": "maintain HR < 140, muscle fatigue after 15~16km, no damage on cardio system"}, {"date": "2025-10-19", "type": "recovery", "dist_km": 8.0, "pace_minpkm": 7.8333333333, "hr_avg": 143.0, "rpe": 3.0, "notes": "Running w/ novice friend, build up from+H96 9:00/km to 7:00/km"}, {"date": "2025-10-20", "type": "easy", "dist_km": 10.0, "pace_minpkm": 6.9, "hr_avg": 141.0, "rpe": 6.0, "notes": "Running w/ novice friend, recovery jog 5km + tempo run 5km (~5:30/km)"}, {"date": "2025-10-21", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.6333333333, "hr_avg": 157.0, "rpe": 7.5, "notes": "WU 1km; <5:30/km 4km, ankle pain for first 1km, started bit side stitch 4km, faster than I felt since 3km."}, {"date": "2025-10-21", "type": "recovery", "dist_km": 5.11, "pace_minpkm": 8.3, "hr_avg": 125.0, "rpe": 1.0, "notes": "Running w/ novice friend, Slow and recovery focused. 4:20/km pace sprint for last 150m"}, {"date": "2025-10-22", "type": "easy", "dist_km": 10.0, "pace_minpkm": 8.6166666667, "hr_avg": 127.0, "rpe": 2.0, "notes": "Running w/ novice friend, Slow and recovery focused. Felt a bit fatigue"}, {"date": "2025-10-23", "type": "easy", "dist_km": 2.0, "pace_minpkm": 7.1166666667, "hr_avg": 138.0, "rpe": 2.0, "notes": "warm up for pace training, feel bit fatigue, but still can run."}, {"date": "2025-10-23", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.3666666667, "hr_avg": 172.0, "rpe": 7.0, "notes": "Tried to run faster than 5:30/km, there were headwind after 2km point. Still managable."}];
const WEEKLY = [{"week": "2025-07-14", "dist_km": 5.0, "runs": 1, "pace_minpkm": 7.9, "rpe": 7.5}, {"week": "2025-07-28", "dist_km": 19.0, "runs": 3, "pace_minpkm": 7.6388888889, "rpe": 5.1666666667}, {"week": "2025-08-04", "dist_km": 51.37, "runs": 7, "pace_minpkm": 7.7928571429, "rpe": 4.6428571429}, {"week": "2025-08-11", "dist_km": 50.57, "runs": 6, "pace_minpkm": 7.4416666667, "rpe": 5.25}, {"week": "2025-08-18", "dist_km": 58.53, "runs": 6, "pace_minpkm": 7.2194444444, "rpe": 5.0833333333}, {"week": "2025-08-25", "dist_km": 20.53, "runs": 2, "pace_minpkm": 7.65, "rpe": 3.75}, {"week": "2025-09-01", "dist_km": 10.02, "runs": 1, "pace_minpkm": 7.0833333333, "rpe": 5.0}, {"week": "2025-09-08", "dist_km": 23.05, "runs": 3, "pace_minpkm": 6.5722222222, "rpe": 3.6666666667}, {"week": "2025-09-15", "dist_km": 37.15, "runs": 4, "pace_minpkm": 6.5291666667, "rpe": 4.25}, {"week": "2025-09-22", "dist_km": 21.1, "runs": 1, "pace_minpkm": 6.5, "rpe": 8.0}, {"week": "2025-09-29", "dist_km": 10.47, "runs": 1, "pace_minpkm": 7.35, "rpe": 7.0}, {"week": "2025-10-06", "dist_km": 33.1, "runs": 3, "pace_minpkm": 8.6222222222, "rpe": 3.8333333333}, {"week": "2025-10-13", "dist_km": 66.1, "runs": 7, "pace_minpkm": 7.35, "rpe": 4.2857142857}, {"week": "2025-10-20", "dist_km": 37.11, "runs": 6, "pace_minpkm": 6.9888888889, "rpe": 4.25}];

const typeSelect = document.getElementById('typeFilter');
const types = Array.from(new Set(DAILY.map(d => d.type))).filter(Boolean);
types.forEach(t => { const o=document.createElement('option'); o.value=t; o.innerText=t; typeSelect.appendChild(o); });

const fromInput = document.getElementById('fromDate');
const toInput = document.getElementById('toDate');
const dates = DAILY.map(d => d.date).sort();
if (dates.length) { fromInput.value = dates[0]; toInput.value = dates[dates.length-1]; }

const paceModeSel = document.getElementById('paceMode');
const rollStatSel = document.getElementById('rollStat');
const rollWinSel = document.getElementById('rollWin');
const weeklyGoalInput = document.getElementById('weeklyGoal');

function filteredDaily() {
  const t = typeSelect.value;
  const from = fromInput.value || '0000-01-01';
  const to = toInput.value || '9999-12-31';
  return DAILY.filter(d => (t==='__ALL__' || d.type===t) && d.date>=from && d.date<=to);
}

function rolling(values, window, stat) {
  const out = new Array(values.length).fill(null);
  for (let i=0; i<values.length; i++) {
    const start = Math.max(0, i-window+1);
    const seg = values.slice(start, i+1).filter(v => v!=null && !Number.isNaN(v));
    if (!seg.length) continue;
    if (stat==='median') {
      const s = seg.slice().sort((a,b)=>a-b);
      const m = Math.floor(s.length/2);
      out[i] = s.length%2 ? s[m] : (s[m-1]+s[m])/2;
    } else {
      out[i] = seg.reduce((a,b)=>a+b,0)/seg.length;
    }
  }
  return out;
}

function render() {
  const d = filteredDaily();
  const x = d.map(r => r.date);

  const dist = d.map(r => (r.dist_km!=null? +r.dist_km : null));
  const rw = +rollWinSel.value;
  const rs = rollStatSel.value;
  const distRoll = rolling(dist, rw, rs);

  Plotly.newPlot('distDaily', [
    { x, y: dist, mode: 'lines+markers', name: '거리(km)', hovertemplate: '%{x}<br>%{y:.2f} km<extra></extra>' },
    { x, y: distRoll, mode: 'lines', name: `이동${rs==='median'?'중앙값':'평균'}(${rw}일)`, hovertemplate: '%{x}<br>%{y:.2f} km (roll)<extra></extra>' }
  ], { margin: {t:30,l:40,r:10,b:40}, xaxis: {title:'날짜'}, yaxis: {title:'km'} }, {displayModeBar:false});

  const paceTitle = document.getElementById('paceTitle');
  const mode = paceModeSel.value;
  let series = null, seriesRoll = null, yaxis = {title:''}, hover = '';

  if (mode==='pace') {
    series = d.map(r => (r.pace_minpkm!=null? +r.pace_minpkm : null));
    seriesRoll = rolling(series, rw, rs);
    yaxis = {title:'분/ km', autorange:'reversed'};
    hover = '%{x}<br>%{y:.2f} 분/km<extra></extra>';
    paceTitle.textContent = '일일 페이스 (분/km) + 이동통계';
  } else {
    series = d.map(r => (r.pace_minpkm!=null? (60.0/ +r.pace_minpkm) : null));
    seriesRoll = rolling(series, rw, rs);
    yaxis = {title:'km/h'};
    hover = '%{x}<br>%{y:.2f} km/h<extra></extra>';
    paceTitle.textContent = '일일 스피드 (km/h) + 이동통계';
  }

  Plotly.newPlot('paceDaily', [
    { x, y: series, mode: 'lines+markers', name: (mode==='pace'?'페이스':'스피드'), hovertemplate: hover },
    { x, y: seriesRoll, mode: 'lines', name: `이동${rs==='median'?'중앙값':'평균'}(${rw}일)`, hovertemplate: hover }
  ], { margin: {t:30,l:50,r:10,b:40}, xaxis: {title:'날짜'}, yaxis }, {displayModeBar:false});

  Plotly.newPlot('rpeDaily', [
    { x, y: d.map(r => +r.rpe), mode: 'lines+markers', name: 'RPE', hovertemplate: '%{x}<br>RPE %{y}<extra></extra>' }
  ], { margin: {t:30,l:40,r:10,b:40}, xaxis: {title:'날짜'}, yaxis: {title:'RPE', rangemode:'tozero'} }, {displayModeBar:false});

  const goal = Math.max(0, +weeklyGoalInput.value || 0);
  const weekX = WEEKLY.map(w => w.week);
  const weekDist = WEEKLY.map(w => +w.dist_km);
  Plotly.newPlot('weeklyTotals', [
    { x: weekX, y: weekDist, type: 'bar', name: '주간 거리(km)', hovertemplate: '%{x} 주<br>%{y:.1f} km<extra></extra>' },
    { x: weekX, y: new Array(weekX.length).fill(goal), mode: 'lines', name: '목표선', hovertemplate: '%{x} 주<br>목표 %{y:.1f} km<extra></extra>' }
  ], { margin: {t:30,l:40,r:40,b:40}, xaxis: {title:'주'}, yaxis: {title:'거리(km)'} }, {displayModeBar:false});

  const paceVals = d.map(r => (r.pace_minpkm!=null? +r.pace_minpkm : null)).filter(v => v!=null);
  const speedVals = paceVals.map(p => 60.0/p);
  Plotly.newPlot('histPace', [
    { x: (paceModeSel.value==='pace'? paceVals : speedVals), type:'histogram', name:(paceModeSel.value==='pace'?'페이스(분/km)':'스피드(km/h)') }
  ], { margin: {t:30,l:40,r:10,b:30}, xaxis: {title:(paceModeSel.value==='pace'?'분/ km':'km/h')}, yaxis: {title:'카운트'} }, {displayModeBar:false});

  Plotly.newPlot('histDistRpe', [
    { x: dist.filter(v=>v!=null), type:'histogram', name:'거리(km)', opacity:0.75 },
    { x: d.map(r=>+r.rpe), type:'histogram', name:'RPE', opacity:0.6 }
  ], { barmode:'overlay', margin: {t:30,l:40,r:10,b:30}, xaxis: {title:'값'}, yaxis: {title:'카운트'} }, {displayModeBar:false});

  const byType = {};
  d.forEach(r => {
    const key = r.type || 'unknown';
    if (!byType[key]) byType[key] = [];
    const v = (paceModeSel.value==='pace' ? (r.pace_minpkm!=null? +r.pace_minpkm : null) : (r.pace_minpkm!=null? 60.0/+r.pace_minpkm : null));
    if (v!=null && !Number.isNaN(v)) byType[key].push(v);
  });
  const boxTraces = Object.keys(byType).sort().map(k => ({ y: byType[k], type:'box', name:k, boxpoints:false }));
  Plotly.newPlot('boxByType', boxTraces, { margin: {t:30,l:40,r:10,b:30}, yaxis: {title:(paceModeSel.value==='pace'?'분/ km (낮을수록 좋음)':'km/h (높을수록 좋음)')}, xaxis: {title:'타입'} }, {displayModeBar:false});

  const effX = [];
  const effY = [];
  d.forEach(r => {
    const p = (r.pace_minpkm!=null? +r.pace_minpkm : null);
    const hr = (r.hr_avg!=null? +r.hr_avg : null);
    if (p!=null && hr!=null && !Number.isNaN(p) && !Number.isNaN(hr) && hr>0) {
      const speed = 60.0/p;
      effX.push(r.date);
      effY.push(speed / hr);
    }
  });
  Plotly.newPlot('efficiency', [
    { x: effX, y: effY, mode:'lines+markers', name:'speed/HR', hovertemplate:'%{x}<br>%{y:.4f}} (km/h)/bpm<extra></extra>' }
  ], { margin: {t:30,l:40,r:10,b:40}, xaxis: {title:'날짜'}, yaxis: {title:'효율 지수 (km/h per bpm)'} }, {displayModeBar:false});

  const notes = document.getElementById('notes');
  const clickHandler = (data) => {
    if (!data.points || !data.points.length) return;
    const idx = data.points[0].pointIndex;
    const row = d[idx];
    if (!row) return;
    const text = [
      `날짜: ${row.date}`,
      `종류: ${row.type}`,
      `거리: ${row.dist_km} km`,
      `페이스: ${row.pace_minpkm} 분/km (스피드 ${(row.pace_minpkm? (60/row.pace_minpkm).toFixed(2):'N/A')} km/h)`,
      `평균 심박: ${row.hr_avg ?? 'N/A'}`,
      `RPE: ${row.rpe}`,
      '',
      (row.notes || '(노트 없음)')
    ].join('\\n');
    notes.textContent = text;
  };
  ['distDaily','paceDaily','rpeDaily'].forEach(id => {
    const gd = document.getElementById(id);
    gd.on('plotly_click', clickHandler);
  });
}

render();
document.getElementById('apply').onclick = render;
document.getElementById('reset').onclick = () => {
  typeSelect.value='__ALL__';
  fromInput.value = dates[0];
  toInput.value = dates[dates.length-1];
  paceModeSel.value='pace';
  rollStatSel.value='mean';
  rollWinSel.value='7';
  weeklyGoalInput.value='30';
  render();
};
</script>
</body>
</html>

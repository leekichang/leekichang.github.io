<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Running Dashboard</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:24px}
  h1{margin-bottom:0}.sub{color:#555;margin-top:4px}
  .grid{display:grid;gap:20px}.two{grid-template-columns:1fr}.three{grid-template-columns:1fr}
  @media(min-width:1024px){.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:1fr 1fr 1fr}}
  .card{border:1px solid #eee;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
  .controls label{display:flex;gap:6px;align-items:center}
  input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #ddd}
  #notes{white-space:pre-wrap;background:#fafafa;border-radius:8px;padding:12px;border:1px solid #eee}
  .muted{color:#666;font-size:12px}.spacer{flex:1 1 auto}
</style>
</head>
<body>
<h1 id="title">Running Dashboard</h1>
<div class="sub" id="subtitle">Daily/weekly trends, moving stats, pace↔speed, distributions, box plots, efficiency.</div>

<div class="card">
  <div class="controls">
    <label><span id="lblLang">Language</span>
      <select id="langSel">
        <option value="en">English</option>
        <option value="ko">한국어</option>
      </select>
    </label>
    <div class="spacer"></div>
    <label><span id="lblType">Type</span>
      <select id="typeFilter"><option value="__ALL__" id="optAll">All</option></select>
    </label>
    <label><span id="lblRange">Date</span>
      <input type="date" id="fromDate"> ~ <input type="date" id="toDate">
    </label>
    <label><span id="lblUnit">Unit</span>
      <select id="paceMode">
        <option value="pace" id="optPace">Pace (min/km)</option>
        <option value="speed" id="optSpeed">Speed (km/h)</option>
      </select>
    </label>
    <label><span id="lblRollStat">Rolling</span>
      <select id="rollStat">
        <option value="mean" id="optMean">Mean</option>
        <option value="median" id="optMedian">Median</option>
      </select>
    </label>
    <label><span id="lblWindow">Window</span>
      <select id="rollWin"><option value="7">7 days</option><option value="28">28 days</option></select>
    </label>
    <label><span id="lblGoal">Weekly goal (km)</span>
      <input type="number" id="weeklyGoal" value="30" min="0" step="1" style="width:110px;">
    </label>
    <button id="apply">Apply</button><button id="reset">Reset</button>
  </div>
  <div class="muted" id="hintClick">Tip: click a point to show notes below.</div>
</div>

<div class="grid two">
  <div class="card"><h3 id="hDailyDist">Daily distance (km) + rolling</h3><div id="distDaily" style="height:360px;"></div></div>
  <div class="card"><h3 id="hDailyPace">Daily pace (min/km) + rolling</h3><div id="paceDaily" style="height:360px;"></div></div>
</div>

<div class="grid two">
  <div class="card"><h3 id="hDailyRpe">Daily RPE</h3><div id="rpeDaily" style="height:300px;"></div></div>
  <div class="card"><h3 id="hWeeklyTotals">Weekly total vs goal</h3><div id="weeklyTotals" style="height:320px;"></div></div>
</div>

<div class="grid three">
  <div class="card"><h3 id="hHistPace">Distribution: pace/speed</h3><div id="histPace" style="height:280px;"></div></div>
  <div class="card"><h3 id="hHistDistRpe">Distribution: distance & RPE</h3><div id="histDistRpe" style="height:280px;"></div></div>
  <div class="card"><h3 id="hBoxByType">Box: by type</h3><div id="boxByType" style="height:280px;"></div></div>
</div>

<div class="card">
  <h3 id="hEfficiency">Efficiency (speed / HR)</h3>
  <div id="efficiency" style="height:320px;"></div>
  <div class="muted" id="hintHrMissing">* Days without HR are omitted.</div>
</div>

<div class="card">
  <h3 id="hNotes">Selected notes</h3>
  <div id="notes">(Click a point)</div>
</div>

<script>
const STR = {
  en:{title:"Running Dashboard",subtitle:"Daily/weekly trends, moving stats, pace↔speed, distributions, box plots, efficiency.",
      Language:"Language",Type:"Type",All:"All",Date:"Date",Unit:"Unit",Rolling:"Rolling",Mean:"Mean",Median:"Median",
      Window:"Window",WeeklyGoal:"Weekly goal (km)",Apply:"Apply",Reset:"Reset",
      HintClick:"Tip: click a point to show notes below.",
      DailyDist:"Daily distance (km) + rolling",DailyPace:"Daily pace (min/km) + rolling",DailySpeed:"Daily speed (km/h) + rolling",
      DailyRpe:"Daily RPE",WeeklyTotals:"Weekly total vs goal",HistPace:"Distribution: pace/speed",
      HistDistRpe:"Distribution: distance & RPE",BoxByType:"Box: by type",Efficiency:"Efficiency (speed / HR)",
      HrMissing:"* Days without HR are omitted.",Notes:"Selected notes",
      axisDate:"Date",axisKm:"km",axisMinPerKm:"min / km",axisKmH:"km/h",axisRpe:"RPE",axisCount:"Count",axisType:"Type",axisEff:"Efficiency (km/h per bpm)",
      traceDist:"Distance (km)",traceRollingMean:"Rolling mean",traceRollingMedian:"Rolling median",tracePace:"Pace",traceSpeed:"Speed",traceRpe:"RPE",traceGoal:"Goal",
      tooltipPace:"%{x}<br>%{y:.2f} min/km",tooltipSpeed:"%{x}<br>%{y:.2f} km/h",tooltipKm:"%{x}<br>%{y:.2f} km",tooltipWeekKm:"%{x}<br>%{y:.1f} km",
      tooltipEff:"%{x}<br>%{y:.4f} (km/h)/bpm",clickDate:"Date",clickType:"Type",clickDist:"Distance",clickPace:"Pace",clickSpeed:"Speed",clickHR:"Avg HR",clickRPE:"RPE",clickNoNotes:"(No notes)"},
  ko:{title:"러닝 대시보드",subtitle:"일일/주간 추이, 이동통계, 페이스↔스피드, 분포, 상자그림, 효율 지수.",
      Language:"언어",Type:"종류",All:"모두",Date:"기간",Unit:"값 단위",Rolling:"이동 통계",Mean:"평균",Median:"중앙값",
      Window:"윈도우",WeeklyGoal:"주간 목표(km)",Apply:"적용",Reset:"초기화",
      HintClick:"포인트를 클릭하면 아래 노트가 표시됩니다.",
      DailyDist:"일일 거리 (km) + 이동통계",DailyPace:"일일 페이스 (분/km) + 이동통계",DailySpeed:"일일 스피드 (km/h) + 이동통계",
      DailyRpe:"일일 RPE",WeeklyTotals:"주간 합계 vs 목표",HistPace:"분포: 페이스/스피드",
      HistDistRpe:"분포: 거리 & RPE",BoxByType:"상자그림: 타입별",Efficiency:"효율 지수 (speed / HR)",
      HrMissing:"* HR이 비어있는 날은 제외됩니다.",Notes:"선택한 러닝 노트",
      axisDate:"날짜",axisKm:"km",axisMinPerKm:"분 / km",axisKmH:"km/h",axisRpe:"RPE",axisCount:"카운트",axisType:"타입",axisEff:"효율 지수 (km/h per bpm)",
      traceDist:"거리(km)",traceRollingMean:"이동평균",traceRollingMedian:"이동중앙값",tracePace:"페이스",traceSpeed:"스피드",traceRpe:"RPE",traceGoal:"목표선",
      tooltipPace:"%{x}<br>%{y:.2f} 분/km",tooltipSpeed:"%{x}<br>%{y:.2f} km/h",tooltipKm:"%{x}<br>%{y:.2f} km",tooltipWeekKm:"%{x}<br>%{y:.1f} km",
      tooltipEff:"%{x}<br>%{y:.4f} (km/h)/bpm",clickDate:"날짜",clickType:"종류",clickDist:"거리",clickPace:"페이스",clickSpeed:"스피드",clickHR:"평균 심박",clickRPE:"RPE",clickNoNotes:"(노트 없음)"}
};

const DAILY = [{"date": "2025-07-20", "type": "easy", "dist_km": 5.0, "pace_minpkm": 7.9, "hr_avg": 163.0, "rpe": 7.5, "notes": "Track; 30\"¡¿7 cadence drill after; heat ~28C"}, {"date": "2025-08-01", "type": "tempo", "dist_km": 6.0, "pace_minpkm": 7.35, "hr_avg": 165.0, "rpe": 8.0, "notes": "Splits ~6:53; last 6:31"}, {"date": "2025-08-02", "type": "lsd", "dist_km": 12.0, "pace_minpkm": 8.7666666667, "hr_avg": 155.0, "rpe": 3.5, "notes": "Mild knee pain ~8km"}, {"date": "2025-08-03", "type": "easy", "dist_km": 1.0, "pace_minpkm": 6.8, "hr_avg": 144.0, "rpe": 4.0, "notes": "nan"}, {"date": "2025-08-04", "type": "recovery", "dist_km": 6.25, "pace_minpkm": 8.3166666667, "hr_avg": 150.0, "rpe": 4.0, "notes": "Slight knee discomfort ~5km; last 1km ~5:18"}, {"date": "2025-08-05", "type": "intervals", "dist_km": 6.0, "pace_minpkm": 7.1666666667, "hr_avg": 151.0, "rpe": 6.5, "notes": "2km WU; 400m on/off, 400m¡¿5"}, {"date": "2025-08-06", "type": "easy", "dist_km": 6.01, "pace_minpkm": 7.9666666667, "hr_avg": 144.0, "rpe": 3.0, "notes": "Last 1km faster"}, {"date": "2025-08-07", "type": "tempo", "dist_km": 7.0, "pace_minpkm": 6.5166666667, "hr_avg": 153.0, "rpe": 4.0, "notes": "RPE blocks 5?6¡æ6?7¡æ7?8"}, {"date": "2025-08-08", "type": "easy", "dist_km": 6.0, "pace_minpkm": 8.2333333333, "hr_avg": 151.0, "rpe": 5.0, "notes": "Hot; hip discomfort"}, {"date": "2025-08-09", "type": "lsd", "dist_km": 15.0, "pace_minpkm": 7.7666666667, "hr_avg": 147.0, "rpe": 6.0, "notes": "Hip improved; knee discomfort after 10km"}, {"date": "2025-08-10", "type": "easy", "dist_km": 5.11, "pace_minpkm": 8.5833333333, "hr_avg": 150.0, "rpe": 4.0, "notes": "Ran with friend; last 1km faster"}, {"date": "2025-08-11", "type": "easy", "dist_km": 8.11, "pace_minpkm": 7.55, "hr_avg": 144.0, "rpe": 4.0, "notes": "Last 2km faster"}, {"date": "2025-08-12", "type": "intervals", "dist_km": 8.0, "pace_minpkm": 7.0, "hr_avg": 136.0, "rpe": 8.0, "notes": "WU 2km; HRpeak 175; side stitch from rep3, 800m¡¿5"}, {"date": "2025-08-14", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 7.1666666667, "hr_avg": 145.0, "rpe": 7.0, "notes": "Cut short; low energy"}, {"date": "2025-08-15", "type": "easy", "dist_km": 8.15, "pace_minpkm": 7.2833333333, "hr_avg": 145.0, "rpe": 5.0, "notes": "Hip discomfort persists; fatigue"}, {"date": "2025-08-16", "type": "lsd", "dist_km": 16.0, "pace_minpkm": 6.7333333333, "hr_avg": 155.0, "rpe": 4.0, "notes": "Felt depleted late; need gels"}, {"date": "2025-08-17", "type": "easy", "dist_km": 5.31, "pace_minpkm": 8.9166666667, "hr_avg": 117.0, "rpe": 3.5, "notes": "Heavy first 2km then ok"}, {"date": "2025-08-18", "type": "easy", "dist_km": 8.15, "pace_minpkm": 7.2166666667, "hr_avg": 144.0, "rpe": 3.0, "notes": "Segments; 400m @5:00 inside"}, {"date": "2025-08-19", "type": "intervals", "dist_km": 9.6, "pace_minpkm": 4.8333333333, "hr_avg": 172.0, "rpe": 8.0, "notes": "Good HR recovery; stitch mid-session 800m¡¿5"}, {"date": "2025-08-20", "type": "easy", "dist_km": 6.33, "pace_minpkm": 9.2, "hr_avg": 132.0, "rpe": 1.5, "notes": "nan"}, {"date": "2025-08-22", "type": "tempo", "dist_km": 8.02, "pace_minpkm": 6.9, "hr_avg": 151.0, "rpe": 6.0, "notes": "Steady; one fast km 5:45"}, {"date": "2025-08-23", "type": "easy", "dist_km": 5.32, "pace_minpkm": 7.8333333333, "hr_avg": 140.0, "rpe": 4.0, "notes": "nan"}, {"date": "2025-08-24", "type": "lsd", "dist_km": 21.11, "pace_minpkm": 7.3333333333, "hr_avg": 147.0, "rpe": 8.0, "notes": "nan"}, {"date": "2025-08-28", "type": "easy", "dist_km": 6.52, "pace_minpkm": 7.8166666667, "hr_avg": 144.0, "rpe": 3.0, "notes": "nan"}, {"date": "2025-08-31", "type": "lsd", "dist_km": 14.01, "pace_minpkm": 7.4833333333, "hr_avg": 147.0, "rpe": 4.5, "notes": "+89m elevation; late fatigue"}, {"date": "2025-09-05", "type": "easy", "dist_km": 10.02, "pace_minpkm": 7.0833333333, "hr_avg": 144.0, "rpe": 5.0, "notes": "No HR"}, {"date": "2025-09-08", "type": "easy", "dist_km": 5.03, "pace_minpkm": 6.6833333333, "hr_avg": 144.0, "rpe": 3.0, "notes": "Return after weather break"}, {"date": "2025-09-10", "type": "tempo", "dist_km": 10.01, "pace_minpkm": 6.6166666667, "hr_avg": 153.0, "rpe": 4.0, "notes": "Finish 1km 5:38"}, {"date": "2025-09-10", "type": "tempo", "dist_km": 8.01, "pace_minpkm": 6.4166666667, "hr_avg": 161.0, "rpe": 4.0, "notes": "High HR; hill +60m"}, {"date": "2025-09-15", "type": "easy", "dist_km": 12.02, "pace_minpkm": 7.0666666667, "hr_avg": 152.0, "rpe": 5.0, "notes": "Zone2-3; one km @6:18"}, {"date": "2025-09-16", "type": "tempo", "dist_km": 8.12, "pace_minpkm": 6.3666666667, "hr_avg": 157.0, "rpe": 4.0, "notes": "Strong steady run"}, {"date": "2025-09-17", "type": "tempo", "dist_km": 8.01, "pace_minpkm": 6.4, "hr_avg": 152.0, "rpe": 3.0, "notes": "3km <6:00 within; finish 5:58"}, {"date": "2025-09-18", "type": "tempo", "dist_km": 9.0, "pace_minpkm": 6.2833333333, "hr_avg": 153.0, "rpe": 5.0, "notes": "nan"}, {"date": "2025-09-28", "type": "race", "dist_km": 21.1, "pace_minpkm": 6.5, "hr_avg": 161.0, "rpe": 8.0, "notes": "Official 2:17:11; avg 6:30/km"}, {"date": "2025-10-05", "type": "easy", "dist_km": 10.47, "pace_minpkm": 7.35, "hr_avg": 148.0, "rpe": 7.0, "notes": "Side stitch pain"}, {"date": "2025-10-08", "type": "lsd", "dist_km": 26.0, "pace_minpkm": 9.45, "hr_avg": 140.0, "rpe": 4.0, "notes": "Long run"}, {"date": "2025-10-12", "type": "easy", "dist_km": 5.07, "pace_minpkm": 10.5666666667, "hr_avg": 120.0, "rpe": 1.0, "notes": "Running w/ novice friend"}, {"date": "2025-10-12", "type": "tempo", "dist_km": 2.03, "pace_minpkm": 5.85, "hr_avg": 155.0, "rpe": 6.5, "notes": "short high intensity run"}, {"date": "2025-10-14", "type": "easy", "dist_km": 4.1, "pace_minpkm": 8.4666666667, "hr_avg": 137.0, "rpe": 2.0, "notes": "Running w/ novice friend"}, {"date": "2025-10-14", "type": "tempo", "dist_km": 7.0, "pace_minpkm": 6.9, "hr_avg": 153.0, "rpe": 5.0, "notes": "Track; Tried to keep sub 7:00/km, Fatigue after previous running"}, {"date": "2025-10-15", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.8333333333, "hr_avg": 164.0, "rpe": 7.0, "notes": "Track; Tried to keep sub 6:00/km, HR upto 179, 3km PR 17:23"}, {"date": "2025-10-15", "type": "recovery", "dist_km": 12.0, "pace_minpkm": 7.8, "hr_avg": 148.0, "rpe": 5.0, "notes": "Recovery, bit fatigue after 10km"}, {"date": "2025-10-16", "type": "fartlek", "dist_km": 10.0, "pace_minpkm": 7.1833333333, "hr_avg": 145.0, "rpe": 3.0, "notes": "Running w/ novice friend, Sprint upto 4:25"}, {"date": "2025-10-18", "type": "lsd", "dist_km": 20.0, "pace_minpkm": 7.4333333333, "hr_avg": 138.0, "rpe": 5.0, "notes": "maintain HR < 140, muscle fatigue after 15~16km, no damage on cardio system"}, {"date": "2025-10-19", "type": "recovery", "dist_km": 8.0, "pace_minpkm": 7.8333333333, "hr_avg": 143.0, "rpe": 3.0, "notes": "Running w/ novice friend, build up from+H96 9:00/km to 7:00/km"}, {"date": "2025-10-20", "type": "recovery", "dist_km": 10.0, "pace_minpkm": 6.9, "hr_avg": 141.0, "rpe": 6.0, "notes": "Running w/ novice friend, recovery jog 5km + tempo run 5km (~5:30/km)"}, {"date": "2025-10-21", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.6333333333, "hr_avg": 157.0, "rpe": 7.5, "notes": "WU 1km; <5:30/km 4km, ankle pain for first 1km, started bit side stitch 4km, faster than I felt since 3km."}, {"date": "2025-10-21", "type": "recovery", "dist_km": 5.11, "pace_minpkm": 8.3, "hr_avg": 125.0, "rpe": 1.0, "notes": "Running w/ novice friend, Slow and recovery focused. 4:20/km pace sprint for last 150m"}, {"date": "2025-10-22", "type": "recovery", "dist_km": 10.0, "pace_minpkm": 8.6166666667, "hr_avg": 127.0, "rpe": 2.0, "notes": "Running w/ novice friend, Slow and recovery focused. Felt a bit fatigue"}, {"date": "2025-10-23", "type": "recovery", "dist_km": 2.0, "pace_minpkm": 7.1166666667, "hr_avg": 138.0, "rpe": 2.0, "notes": "warm up for pace training, feel bit fatigue, but still can run."}, {"date": "2025-10-23", "type": "tempo", "dist_km": 5.0, "pace_minpkm": 5.3666666667, "hr_avg": 172.0, "rpe": 7.0, "notes": "Tried to run faster than 5:30/km, there were headwind after 2km point. Still managable."}, {"date": "2025-10-28", "type": "tempo", "dist_km": 6.0, "pace_minpkm": 5.7333333333, "hr_avg": 154.0, "rpe": 6.0, "notes": "Did not care about the pace or heart rate, focused on the respiration and feeling. Bit pain in left Tibialis Anterior. Sprint for last 200m ~4:30/km"}, {"date": "2025-10-28", "type": "recovery", "dist_km": 1.67, "pace_minpkm": 7.2, "hr_avg": 148.0, "rpe": 2.0, "notes": "Cool down after previous session."}, {"date": "2025-10-29", "type": "recovery", "dist_km": 10.3, "pace_minpkm": 7.1166666667, "hr_avg": 147.0, "rpe": 2.5, "notes": "Recovery after leg day, 50~100m sprint for each 3km. Max pace 2'29/km."}, {"date": "2025-11-02", "type": "tempo", "dist_km": 5.23, "pace_minpkm": 5.15, "hr_avg": 150.0, "rpe": 5.0, "notes": "Treadmill run, Build up and max 5:00"}, {"date": "2025-11-03", "type": "recovery", "dist_km": 3.28, "pace_minpkm": 5.95, "hr_avg": 142.0, "rpe": 3.0, "notes": "Treadmill run, pack with schedule mini recovery session."}, {"date": "2025-11-04", "type": "easy", "dist_km": 11.5, "pace_minpkm": 6.4333333333, "hr_avg": 144.0, "rpe": 5.0, "notes": "Forgot the watch. Ran without HR data. Zone 3 jog."}, {"date": "2025-11-05", "type": "easy", "dist_km": 10.0, "pace_minpkm": 6.6666666667, "hr_avg": 140.0, "rpe": 3.0, "notes": "Found the error with watch, weird HR for first 2km. A bit like a build up style run."}, {"date": "2025-11-06", "type": "tempo", "dist_km": 10.0, "pace_minpkm": 5.6166666667, "hr_avg": 165.0, "rpe": 7.5, "notes": "10K PB, first 10k sub1"}, {"date": "2025-11-16", "type": "recovery", "dist_km": 5.0, "pace_minpkm": 6.2333333333, "hr_avg": 158.0, "rpe": 4.0, "notes": "Recovery from right knee injury"}, {"date": "2025-11-17", "type": "easy", "dist_km": 10.0, "pace_minpkm": 7.0666666667, "hr_avg": 140.0, "rpe": 3.0, "notes": "nan"}, {"date": "2025-11-18", "type": "tempo", "dist_km": 10.0, "pace_minpkm": 6.2666666667, "hr_avg": 163.0, "rpe": 5.0, "notes": "nan"}, {"date": "2025-11-19", "type": "tempo", "dist_km": 6.15, "pace_minpkm": 6.2, "hr_avg": 157.0, "rpe": 5.0, "notes": "nan"}, {"date": "2025-11-20", "type": "tempo", "dist_km": 2.51, "pace_minpkm": 5.2833333333, "hr_avg": 160.0, "rpe": 7.0, "notes": "nan"}, {"date": "2025-11-21", "type": "easy", "dist_km": 10.0, "pace_minpkm": 6.6, "hr_avg": 149.0, "rpe": 4.0, "notes": "nan"}];
const WEEKLY = [{"week": "2025-07-14", "dist_km": 5.0, "runs": 1, "pace_minpkm": 7.9, "rpe": 7.5}, {"week": "2025-07-28", "dist_km": 19.0, "runs": 3, "pace_minpkm": 7.6388888889, "rpe": 5.1666666667}, {"week": "2025-08-04", "dist_km": 51.37, "runs": 7, "pace_minpkm": 7.7928571429, "rpe": 4.6428571429}, {"week": "2025-08-11", "dist_km": 50.57, "runs": 6, "pace_minpkm": 7.4416666667, "rpe": 5.25}, {"week": "2025-08-18", "dist_km": 58.53, "runs": 6, "pace_minpkm": 7.2194444444, "rpe": 5.0833333333}, {"week": "2025-08-25", "dist_km": 20.53, "runs": 2, "pace_minpkm": 7.65, "rpe": 3.75}, {"week": "2025-09-01", "dist_km": 10.02, "runs": 1, "pace_minpkm": 7.0833333333, "rpe": 5.0}, {"week": "2025-09-08", "dist_km": 23.05, "runs": 3, "pace_minpkm": 6.5722222222, "rpe": 3.6666666667}, {"week": "2025-09-15", "dist_km": 37.15, "runs": 4, "pace_minpkm": 6.5291666667, "rpe": 4.25}, {"week": "2025-09-22", "dist_km": 21.1, "runs": 1, "pace_minpkm": 6.5, "rpe": 8.0}, {"week": "2025-09-29", "dist_km": 10.47, "runs": 1, "pace_minpkm": 7.35, "rpe": 7.0}, {"week": "2025-10-06", "dist_km": 33.1, "runs": 3, "pace_minpkm": 8.6222222222, "rpe": 3.8333333333}, {"week": "2025-10-13", "dist_km": 66.1, "runs": 7, "pace_minpkm": 7.35, "rpe": 4.2857142857}, {"week": "2025-10-20", "dist_km": 37.11, "runs": 6, "pace_minpkm": 6.9888888889, "rpe": 4.25}, {"week": "2025-10-27", "dist_km": 23.2, "runs": 4, "pace_minpkm": 6.3, "rpe": 3.875}, {"week": "2025-11-03", "dist_km": 34.78, "runs": 4, "pace_minpkm": 6.1666666667, "rpe": 4.625}, {"week": "2025-11-10", "dist_km": 5.0, "runs": 1, "pace_minpkm": 6.2333333333, "rpe": 4.0}, {"week": "2025-11-17", "dist_km": 38.66, "runs": 5, "pace_minpkm": 6.2833333333, "rpe": 4.8}];

const el = id => document.getElementById(id);
const langSel = el('langSel');
let LANG = localStorage.getItem('runDashLang') || 'en';
langSel.value = LANG;

function applyLang(){
  const S = STR[LANG];
  el('title').textContent = S.title; el('subtitle').textContent = S.subtitle;
  el('lblLang').textContent = S.Language; el('lblType').textContent = S.Type; el('optAll').textContent = S.All;
  el('lblRange').textContent = S.Date; el('lblUnit').textContent = S.Unit;
  el('lblRollStat').textContent = S.Rolling; el('optMean').textContent = S.Mean; el('optMedian').textContent = S.Median;
  el('lblWindow').textContent = S.Window; el('lblGoal').textContent = S.WeeklyGoal;
  el('apply').textContent = S.Apply; el('reset').textContent = S.Reset;
  el('hintClick').textContent = S.HintClick; el('hDailyDist').textContent = S.DailyDist; el('hDailyRpe').textContent = S.DailyRpe;
  el('hWeeklyTotals').textContent = S.WeeklyTotals; el('hHistPace').textContent = S.HistPace; el('hHistDistRpe').textContent = S.HistDistRpe;
  el('hBoxByType').textContent = S.BoxByType; el('hEfficiency').textContent = S.Efficiency; el('hintHrMissing').textContent = S.HrMissing;
  const mode = el('paceMode').value;
  el('optPace').textContent = (LANG==='en'?'Pace (min/km)':'페이스(분/km)');
  el('optSpeed').textContent = (LANG==='en'?'Speed (km/h)':'스피드(km/h)');
  el('hDailyPace').textContent = (mode==='pace'? S.DailyPace : S.DailySpeed);
  render();
}
langSel.onchange = () => { LANG = langSel.value; localStorage.setItem('runDashLang', LANG); applyLang(); };

const typeSelect = el('typeFilter');
const types = Array.from(new Set(DAILY.map(d=>d.type))).filter(Boolean).sort();
types.forEach(t => { const o=document.createElement('option'); o.value=t; o.innerText=t; typeSelect.appendChild(o); });

const fromInput = el('fromDate'), toInput = el('toDate');
const dates = DAILY.map(d=>d.date).sort();
if (dates.length){ fromInput.value = dates[0]; toInput.value = dates[dates.length-1]; }

const paceModeSel = el('paceMode'), rollStatSel = el('rollStat'), rollWinSel = el('rollWin'), weeklyGoalInput = el('weeklyGoal');

function filteredDaily(){
  const t = typeSelect.value, from = fromInput.value || '0000-01-01', to = toInput.value || '9999-12-31';
  return DAILY.filter(d => (t==='__ALL__' || d.type===t) && d.date>=from && d.date<=to);
}

function rolling(values, window, stat){
  const out = new Array(values.length).fill(null);
  for (let i=0;i<values.length;i++){
    const start = Math.max(0,i-window+1);
    const seg = values.slice(start,i+1).filter(v=>v!=null && !Number.isNaN(v));
    if (!seg.length) continue;
    if (stat==='median'){
      const s = seg.slice().sort((a,b)=>a-b); const m = Math.floor(s.length/2);
      out[i] = s.length%2 ? s[m] : (s[m-1]+s[m])/2;
    } else {
      out[i] = seg.reduce((a,b)=>a+b,0)/seg.length;
    }
  }
  return out;
}

function render(){
  const S = STR[LANG], d = filteredDaily(), x = d.map(r=>r.date);
  const dist = d.map(r => (r.dist_km!=null? +r.dist_km : null));
  const rw = +rollWinSel.value, rs = rollStatSel.value, distRoll = rolling(dist, rw, rs);

  Plotly.newPlot('distDaily', [
    { x, y: dist, mode:'lines+markers', name:S.traceDist, hovertemplate:S.tooltipKm+'<extra></extra>' },
    { x, y: distRoll, mode:'lines', name:(rs==='median'?S.traceRollingMedian:S.traceRollingMean), hovertemplate:S.tooltipKm+'<extra></extra>' }
  ], { margin:{t:30,l:40,r:10,b:40}, xaxis:{title:S.axisDate}, yaxis:{title:S.axisKm} }, {displayModeBar:false});

  const mode = paceModeSel.value;
  let series=null, seriesRoll=null, yaxis={title:''}, hover='';
  if (mode==='pace'){ series = d.map(r=>r.pace_minpkm!=null? +r.pace_minpkm:null); seriesRoll = rolling(series,rw,rs);
    yaxis={title:S.axisMinPerKm,autorange:'reversed'}; hover=S.tooltipPace+'<extra></extra>'; el('hDailyPace').textContent=S.DailyPace;
  } else { series=d.map(r=>r.pace_minpkm!=null? (60.0/+r.pace_minpkm):null); seriesRoll=rolling(series,rw,rs);
    yaxis={title:S.axisKmH}; hover=S.tooltipSpeed+'<extra></extra>'; el('hDailyPace').textContent=S.DailySpeed; }

  Plotly.newPlot('paceDaily', [
    { x, y:series, mode:'lines+markers', name:(mode==='pace'?S.tracePace:S.traceSpeed), hovertemplate:hover },
    { x, y:seriesRoll, mode:'lines', name:(rs==='median'?S.traceRollingMedian:S.traceRollingMean), hovertemplate:hover }
  ], { margin:{t:30,l:50,r:10,b:40}, xaxis:{title:S.axisDate}, yaxis }, {displayModeBar:false});

  Plotly.newPlot('rpeDaily', [
    { x, y:d.map(r=>+r.rpe), mode:'lines+markers', name:S.traceRpe, hovertemplate:`%{x}<br>${S.traceRpe} %{y}<extra></extra>` }
  ], { margin:{t:30,l:40,r:10,b:40}, xaxis:{title:S.axisDate}, yaxis:{title:S.axisRpe, rangemode:'tozero'} }, {displayModeBar:false});

  const goal = Math.max(0, +weeklyGoalInput.value || 0);
  const weekX = WEEKLY.map(w=>w.week), weekDist = WEEKLY.map(w=>+w.dist_km);
  Plotly.newPlot('weeklyTotals', [
    { x:weekX, y:weekDist, type:'bar', name:S.WeeklyTotals, hovertemplate:S.tooltipWeekKm+'<extra></extra>' },
    { x:weekX, y:new Array(weekX.length).fill(goal), mode:'lines', name:S.traceGoal, hovertemplate:S.tooltipWeekKm+'<extra></extra>' }
  ], { margin:{t:30,l:40,r:40,b:40}, xaxis:{title:S.axisDate}, yaxis:{title:S.axisKm} }, {displayModeBar:false});

  const paceVals = d.map(r=>r.pace_minpkm!=null? +r.pace_minpkm:null).filter(v=>v!=null);
  const speedVals = paceVals.map(p=>60.0/p);
  Plotly.newPlot('histPace', [
    { x:(paceModeSel.value==='pace'? paceVals : speedVals), type:'histogram', name:(paceModeSel.value==='pace'? S.tracePace : S.traceSpeed) }
  ], { margin:{t:30,l:40,r:10,b:30}, xaxis:{title:(paceModeSel.value==='pace'? S.axisMinPerKm : S.axisKmH)}, yaxis:{title:S.axisCount} }, {displayModeBar:false});

  Plotly.newPlot('histDistRpe', [
    { x:dist.filter(v=>v!=null), type:'histogram', name:S.traceDist, opacity:0.75 },
    { x:d.map(r=>+r.rpe), type:'histogram', name:S.traceRpe, opacity:0.6 }
  ], { barmode:'overlay', margin:{t:30,l:40,r:10,b:30}, xaxis:{title:'Value'}, yaxis:{title:S.axisCount} }, {displayModeBar:false});

  const byType = {}; d.forEach(r=>{ const k=r.type||'unknown'; (byType[k]=byType[k]||[]).push(
    (paceModeSel.value==='pace'?(r.pace_minpkm!=null?+r.pace_minpkm:null):(r.pace_minpkm!=null?60.0/+r.pace_minpkm:null))
  );});
  const boxTraces = Object.keys(byType).sort().map(k=>({y:byType[k].filter(v=>v!=null), type:'box', name:k, boxpoints:false}));
  Plotly.newPlot('boxByType', boxTraces, { margin:{t:30,l:40,r:10,b:30}, yaxis:{title:(paceModeSel.value==='pace'? S.axisMinPerKm:S.axisKmH)}, xaxis:{title:S.axisType}}, {displayModeBar:false});

  const effX=[], effY=[]; d.forEach(r=>{ const p=r.pace_minpkm, hr=r.hr_avg; if(p!=null && hr!=null && hr>0){ effX.push(r.date); effY.push((60.0/p)/hr); }});
  Plotly.newPlot('efficiency', [{ x:effX, y:effY, mode:'lines+markers', name:S.Efficiency, hovertemplate:S.tooltipEff+'<extra></extra>' }],
    { margin:{t:30,l:40,r:10,b:40}, xaxis:{title:S.axisDate}, yaxis:{title:S.axisEff} }, {displayModeBar:false});

  const notes = document.getElementById('notes');
  const clickHandler = (data)=>{ if(!data.points||!data.points.length) return; const idx=data.points[0].pointIndex; const row=d[idx]; if(!row) return;
    const lines=[ `${STR[LANG].clickDate}: ${row.date}`, `${STR[LANG].clickType}: ${row.type}`, `${STR[LANG].clickDist}: ${row.dist_km} km`,
      `${STR[LANG].clickPace}: ${row.pace_minpkm?.toFixed(2)} ${STR[LANG].axisMinPerKm} (${STR[LANG].clickSpeed} ${(row.pace_minpkm?(60/row.pace_minpkm).toFixed(2):'N/A')} ${STR[LANG].axisKmH})`,
      `${STR[LANG].clickHR}: ${row.hr_avg ?? 'N/A'}`, `${STR[LANG].clickRPE}: ${row.rpe}`, '', (row.notes || STR[LANG].clickNoNotes) ];
    notes.textContent = lines.join('\n'); };
  ['distDaily','paceDaily','rpeDaily'].forEach(id=>{ document.getElementById(id).on('plotly_click', clickHandler); });
}

document.getElementById('apply').onclick = render;
document.getElementById('reset').onclick = ()=>{ typeSelect.value='__ALL__'; fromInput.value=dates[0]; toInput.value=dates[dates.length-1];
  paceModeSel.value='pace'; rollStatSel.value='mean'; rollWinSel.value='7'; weeklyGoalInput.value='30'; render(); };
applyLang();
</script>
</body>
</html>
